var app=angular.module("app",["ui.router","ngCookies","btford.socket-io","ngSanitize"]);app.run(["$templateCache",function(t){t.put("header.html","../views/templates/header.html"),t.put("footer.html","../views/templates/footer.html")}]),function(){app.controller("BodyController",["$rootScope",function(t){t.totalHints=0,t.isSignin=!1,t.currentRoom=""}]).controller("NavbarController",["$scope","$rootScope","$window","socket","AuthFactory","HintFactory",function(t,e,o,n,s,r){var c,i,u=768;e.isAuth=s.checkAuth("User"),s.checkAuth("User")&&(n.emit("update hints",s.getAuth("User").id),s.getAuth("User").currentRoom&&(e.isChatroomAccess=!0)),t.isFolded=i=c=o.document.documentElement.offsetWidth<u?!0:!1,t.toggleNavbar=function(){t.isFolded=c?!t.isFolded:!1},o.onresize=function(){c=o.document.documentElement.offsetWidth<768?!0:!1,i!==c&&(t.isFolded=i=c,t.$apply())},n.on("update hints",function(t){s.getAuth("User")&&s.getAuth("User").id===t&&r.getHintsCount(s.getAuth("User").id+"/"+!1,function(t){console.log(t.status),e.totalHints=t.data},function(t){console.log(t)})})}]).controller("LoginController",["$scope","$rootScope","AuthFactory","socket",function(t,e,o,n){o.checkNotAuth("User"),t.toggleSignin=function(){e.isSignin=!e.isSignin},t.login=function(){t.loginEmail&&t.loginPassword&&o.login({email:t.loginEmail,password:t.loginPassword},function(s){404===s.status.code?(o.checkAuth("User"),t.loginEmail=s.data.email,t.loginPassword=s.data.password,console.log(s.status)):409===s.status.code?(o.checkAuth("User"),t.loginEmail=s.data.email,t.loginPassword=s.data.password,console.log(s.status)):200===s.status.code&&(o.setAuth("User",s.data),e.isAuth=o.checkAuth("User"),e.isChatroomAccess=!1,n.emit("update hints",o.getAuth("User").id),n.emit("update friends",o.getAuth("User").id),o.checkNotAuth("User"),console.log(s.status))},function(t){console.log(t)})}}]).controller("SigninController",["$scope","$rootScope","AuthFactory","socket",function(t,e,o,n){o.checkAuth("User"),t.$watchGroup(["signinPassword","signinConfiration"],function(e){t.isMatch=e[0]===e[1]}),t.signin=function(){t.signinEmail&&t.signinUsername&&t.signinPassword&&t.signinSignature&&o.signin({username:t.signinUsername,password:t.signinPassword,email:t.signinEmail,signature:t.signinSignature},function(n){409===n.status.code?(o.checkAuth("User"),t.signinUsername=n.data.username,t.signinPassword=n.data.password,t.signinEmail=n.data.email,t.signinSignature=n.data.signature,console.log(n.status)):200===n.status.code&&(o.setAuth("User",n.data),e.isAuth=o.checkAuth("User"),e.isChatroomAccess=!1,o.checkNotAuth("User"),console.log(n.status))},function(t){console.log(t)})}}]).controller("LogoutController",["$scope","$rootScope","socket","AuthFactory","RoomFactory",function(t,e,o,n,s){n.checkAuth("User"),t.logout=function(){var t=n.getAuth("User");t.currentRoom&&s.exit({userId:t.id},function(e){console.log(e.status),o.emit("update room info",t.currentRoom)},function(t){}),n.logout({id:t.id},function(e){console.log(e.status),o.emit("update friends",t.id)},function(t){console.log(t)}),e.isAuth=!1,e.username=null,e.totalHints=0,n.removeAuth("User"),n.checkAuth("User")}}]).controller("UserInfoController",["$scope","$rootScope","socket","AuthFactory","FriendFactory",function(t,e,o,n,s){n.checkAuth("User")&&s.getOne(n.getAuth("User").id,function(o){console.log(o.status),e.username=o.data.username,t.signature=o.data.signature},function(t){console.log(t)})}]).controller("ChatController",["$scope","$rootScope","$timeout","$location","$window","socket","AuthFactory","FriendFactory","RoomFactory",function(t,e,o,n,s,r,c,i,u){function a(){u.getOne(c.getAuth("User").currentRoom,function(e){console.log(e.status),t.room=e.data},function(t){console.log(t)})}function l(t){return t.id==c.getAuth("User").id?!0:!1}function h(t){var e=c.getAuth("User").friends;return e&&e.length?e.indexOf(t.id)>=0?!0:!1:void 0}c.checkAuth("User"),u.checkAccess("User"),u.checkAccess("User")&&r.emit("update room info",c.getAuth("User").currentRoom);var d=768;t.isShowRoomInfo=s.document.documentElement.offsetWidth<d?!1:!0,t.message=[];var g;t.convertIdToUsername=function(t,e){if(c.checkAuth("User")&&t){if(t===c.getAuth("User").id)return c.getAuth("User").username;for(var o=e||[],n=o.length,s=0;n>s;s++)if(t===o[s]._id)return o[s].username}},r.on("update room info",function(t){c.getAuth("User")&&t===c.getAuth("User").currentRoom&&a()}),t.sendMessage=function(e){e&&c.getAuth("User").currentRoom&&(r.emit("send message",{username:c.getAuth("User").username,id:c.getAuth("User").id,message:e,date:moment().format("HH:mm:ss"),currentRoom:c.getAuth("User").currentRoom}),t.content="")},t.typing=function(){r.emit("typing",c.getAuth("User").username)},r.on("receive message",function(e){t.room.members.indexOf(e.id)>=0&&e.currentRoom==c.getAuth("User").currentRoom&&(l(e)&&(e.isSelf=l(e),t.message.push(e)),h(e)&&t.message.push(e))}),r.on("typing",function(e){t.typingUsername=e,g&&o.cancel(g),g=o(function(){t.isTyping=!1},350),t.isTyping=!0}),i.getAll(c.getAuth("User").id,function(e){t.friends=e.data},function(t){console.log(t)}),t.exit=function(){u.exit({userId:c.getAuth("User").id},function(t){console.log(t.status),r.emit("update room info",c.getAuth("User").currentRoom),e.isChatroomAccess=!1,n.path("/circle"),e.currentRoom=""},function(t){console.log(t)})}}]).controller("SearchFriendController",["$scope","socket","AuthFactory","SearchFactory","HintFactory",function(t,e,o,n,s){o.checkAuth("User"),t.friends=o.getAuth("User").friends,t.selfId=o.getAuth("User").id,t.searchFriendContent="",t.noSearchResult=!1,t.isApplied=!1,t.searchResult=null,t.search=function(){n.searchUser({content:t.searchFriendContent},function(e){e.data&&e.data.length?(t.searchResult=e.data,t.noSearchResult=!1):(t.searchResult=null,t.noSearchResult=!0)},function(t){console.log(t)}),t.searchFriendContent=""},t.pullRequest=function(t,n){var r=this;t!==o.getAuth("User").id&&s.pullRequest({targetId:t,hintType:"friend request",hintContent:n,senderId:o.getAuth("User").id,senderName:o.getAuth("User").username,mark:!1,accept:!1},function(o){console.log(o.status),e.emit("update hints",t),r.isApplied=!0,r.applyContent=""},function(t){console.log(t)})}}]).controller("HintController",["$scope","$rootScope","socket","AuthFactory","HintFactory","FriendFactory",function(t,e,o,n,s,r){function c(t,e){r.toBeFriends({targetId:t,senderId:e},function(t){console.log(t.status),r.getOne(n.getAuth("User").id,function(t){n.setAuth("User",t.data),s.pullRequest({targetId:e,hintType:"accept request",hintContent:"i accept your request , we are friend now .",senderId:n.getAuth("User").id,senderName:n.getAuth("User").username,mark:!1,accept:!0},function(t){console.log(t.status),o.emit("update hints",e),o.emit("update friends",n.getAuth("User").id)},function(t){console.log(t)})},function(t){console.log(t)})},function(t){console.log(t)})}n.checkAuth("User"),t.isMarked=!1,t.isAccepted=!1,t.friends=n.getAuth("User").friends,s.getAllHints(n.getAuth("User").id,function(e){console.log(e.status),t.hintsList=e.data},function(t){console.log(t)}),t.mark=function(t){var o=this;s.markHint({targetId:n.getAuth("User").id,id:t},function(t){console.log(t.status),o.isMarked=!0,e.totalHints=e.totalHints-1},function(t){console.log(t)})},t.accept=function(t){var o=this;s.acceptHint({targetId:n.getAuth("User").id,id:t},function(t){console.log(t.status),t.data.mark||(o.isMarked=!0,e.totalHints=e.totalHints-1),c(t.data.targetId,t.data.senderId),o.isAccepted=!0},function(t){console.log(t)})}}]).controller("CircleController",["$scope","$rootScope","$location","$window","socket","AuthFactory","HintFactory","FriendFactory","NewsFactory","RoomFactory",function(t,e,o,n,s,r,c,i,u,a){function l(e){u.getAll(r.getAuth("User").id+"/"+e,function(e){console.log(e.status),t.newsList=e.data},function(t){console.log(t)})}function h(){i.getAll(r.getAuth("User").id,function(e){t.friends=e.data},function(t){console.log(t)})}function d(){a.getRooms(r.getAuth("User").id,function(e){console.log(e.status),t.rooms=e.data},function(t){console.log(t)})}if(r.checkAuth("User")){i.getOne(r.getAuth("User").id,function(t){console.log(t.status),r.setAuth("User",t.data)},function(t){console.log(t)}),h(),d(),l(),e.currentRoom=r.getAuth("User").currentRoom,t.isCreateRoom=!1,t.isChecked=!1,t.members=[],t.writeContent="",t.selfId=r.getAuth("User").id,t.page=1;var g=768;t.isShowSelfInfo=t.isShowFriends=t.isShowRooms=n.document.documentElement.offsetWidth<g?!1:!0,t.convertIdToUsername=function(t,e){if(r.checkAuth("User")&&t){if(t===r.getAuth("User").id)return r.getAuth("User").username;for(var o=e||[],n=o.length,s=0;n>s;s++)if(t===o[s]._id)return o[s].username}},s.on("update news",function(e){if(r.checkAuth("User")){var o=r.getAuth("User");(o.id===e||o.friends.indexOf(e)>=0)&&l(t.page)}}),t.hasNext=!0,t.loadNextPage=function(){t.newsList&&t.newsList.length<7*t.page?t.hasNext=!1:(t.hasNext=!0,t.page=t.page+1,l(t.page))},s.on("update friends",function(t){if(r.checkAuth("User")){var e=r.getAuth("User");(e.id===t||e.friends.indexOf(t)>=0)&&h()}}),s.on("update rooms",function(t){t.indexOf(r.getAuth("User").id)>=0&&d()}),t.toggleCheck=function(e){if(t.members.indexOf(e)>=0){var o=t.members.indexOf(e);t.members.splice(o,1),this.isChecked=!1}else t.members.push(e),this.isChecked=!0},t.finish=function(){t.members.push(r.getAuth("User").id),a.create({roomInfo:t.roomInfo,createrId:r.getAuth("User").id,createdDate:new Date,members:t.members,currentMembers:[]},function(e){console.log(e.status),s.emit("update rooms",e.data.members),t.roomInfo="",t.members=[],t.isCreateRoom=!1},function(t){console.log(t)})},t.join=function(t){a.join({userId:r.getAuth("User").id,roomId:t},function(n){console.log(n.status),i.getOne(r.getAuth("User").id,function(n){r.setAuth("User",n.data),e.isChatroomAccess=!0,e.currentRoom=t,o.path("/chatroom")},function(t){console.log(t)})},function(t){console.log(t)})},t.isMarkdown=!1,t.createNews=function(){u.create({publishId:r.getAuth("User").id,publishContent:t.writeContent,isMarkdown:t.isMarkdown},function(e){console.log(e.status),s.emit("update news",r.getAuth("User").id),t.writeContent=""},function(t){console.log(t)}),t.isMarkdown=!1},t.isEdit=!1,t.toggleEdit=function(t,e){this.isEdit=this.isEdit===!1?!0:!1},t.saveNews=function(t,e){this.isEdit=!1,u.save({newsId:t,publishContent:e},function(t){console.log(t.status),s.emit("update news",r.getAuth("User").id)},function(t){console.log(t)})},t.removeNews=function(t){u.remove({newsId:t},function(t){console.log(t.status),s.emit("update news",r.getAuth("User").id)},function(t){console.log(t)})},t.supportNews=function(t){u.support({newsId:t,supporter:r.getAuth("User").id},function(t){console.log(t.status),s.emit("update news",r.getAuth("User").id)},function(t){console.log(t)})},t.saveUserInfo=function(t,o){this.isEdit=!1,i.save({userId:r.getAuth("User").id,username:t,signature:o},function(t){console.log(t.status);var o=r.getAuth("User");o.username=t.data.username,o.signature=t.data.signature,r.setAuth("User",o),e.username=t.data.username,s.emit("update friends",r.getAuth("User").id)},function(t){console.log(t)})}}}])}(),function(){app.directive("headertemplate",["$templateCache",function(t){return{restrict:"E",templateUrl:t.get("header.html")}}]).directive("footertemplate",["$templateCache",function(t){return{restrict:"E",templateUrl:t.get("footer.html")}}])}(),function(){app.factory("AuthFactory",["$http","$cookies","$location","$rootScope",function(t,e,o,n){var s="http://localhost:3000";return{login:function(e,o,n){t.post(s+"/login",e).success(o).error(n)},signin:function(e,o,n){t.post(s+"/signin",e).success(o).error(n)},logout:function(e,o,n){t.post(s+"/logout",e).success(o).error(n)},checkAuth:function(t){return e.getObject(t)?!0:(o.path("/auth"),!1)},checkNotAuth:function(t){e.getObject(t)&&o.path("/circle")},setAuth:function(t,o){e.putObject(t,o)},getAuth:function(t){return e.getObject(t)},removeAuth:function(t){e.remove(t)}}}]).factory("SearchFactory",["$http",function(t){var e="http://localhost:3000";return{searchUser:function(o,n,s){t.post(e+"/search",o).success(n).error(s)}}}]).factory("HintFactory",["$http",function(t){var e="http://localhost:3000";return{getHintsCount:function(o,n,s){t.get(e+"/hints/count/"+o).success(n).error(s)},getAllHints:function(o,n,s){t.get(e+"/hints/all/"+o).success(n).error(s)},pullRequest:function(o,n,s){t.post(e+"/hint",o).success(n).error(s)},markHint:function(o,n,s){t.post(e+"/hint/mark",o).success(n).error(s)},acceptHint:function(o,n,s){t.post(e+"/hint/accept",o).success(n).error(s)}}}]).factory("FriendFactory",["$http",function(t){var e="http://localhost:3000";return{getAll:function(o,n,s){t.get(e+"/friends/all/"+o).success(n).error(s)},getOne:function(o,n,s){t.get(e+"/user/"+o).success(n).error(s)},toBeFriends:function(o,n,s){t.post(e+"/friend/accept",o).success(n).error(s)},save:function(o,n,s){t.post(e+"/user/save",o).success(n).error(s)}}}]).factory("NewsFactory",["$http",function(t){var e="http://localhost:3000";return{getAll:function(o,n,s){t.get(e+"/news/all/"+o).success(n).error(s)},create:function(o,n,s){t.post(e+"/news/create",o).success(n).error(s)},save:function(o,n,s){t.post(e+"/news/save",o).success(n).error(s)},remove:function(o,n,s){t.post(e+"/news/remove",o).success(n).error(s)},support:function(o,n,s){t.post(e+"/news/support",o).success(n).error(s)}}}]).factory("RoomFactory",["$http","$location","AuthFactory",function(t,e,o){var n="http://localhost:3000";return{checkAccess:function(t){return o.getAuth(t).currentRoom?!0:(e.path("/circle"),!1)},getOne:function(e,o,s){t.get(n+"/room/"+e).success(o).error(s)},getRooms:function(e,o,s){t.get(n+"/rooms/"+e).success(o).error(s)},create:function(e,o,s){t.post(n+"/room/create",e).success(o).error(s)},join:function(e,o,s){t.post(n+"/room/join",e).success(o).error(s)},exit:function(e,o,s){t.post(n+"/room/exit",e).success(o).error(s)}}}])}(),function(){app.config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("auth",{url:"/auth",templateUrl:"../views/templates/auth.html"}).state("search",{url:"/search",templateUrl:"../views/templates/search.html"}).state("circle",{url:"/circle",templateUrl:"../views/templates/circle.html"}).state("chatroom",{url:"/chatroom",templateUrl:"../views/templates/chatroom.html"}).state("hint",{url:"/hint",templateUrl:"../views/templates/hint.html"}),e.otherwise("/auth")}])}(),function(){app.factory("socket",["socketFactory",function(t){var e=io.connect("http://localhost:3000");return mySocket=t({ioSocket:e}),mySocket}])}();